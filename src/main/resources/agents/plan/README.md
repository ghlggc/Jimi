# Plan Agent - 任务规划和分解专家

Plan Agent 是 Jimi 框架中专门负责任务规划和分解的 Agent，采用 **Plan-Execute 模式**工作，帮助你将复杂任务分解为清晰的执行计划。

## 核心特性

- ✅ **Plan-Execute 模式**：先完整规划，再有序执行
- ✅ **深度任务分析**：使用 Think 工具进行复杂推理
- ✅ **结构化清单**：创建 5-15 个可执行步骤
- ✅ **进度跟踪**：实时更新任务状态（Pending → In Progress → Done）
- ✅ **动态调整**：根据执行反馈调整计划
- ✅ **智能委托**：将具体执行委托给专业 Agent

## 工作流程

```
用户输入
    ↓
阶段 1: 分析与规划
    ├── Think 深度分析
    ├── 了解项目上下文
    └── SetTodoList 创建任务清单
    ↓
阶段 2: 执行与跟踪
    ├── Task 委托子 Agent 执行
    ├── SetTodoList 更新任务状态
    └── 动态调整计划（如需要）
    ↓
阶段 3: 验证与总结
    ├── 验证所有任务完成
    └── 总结执行情况
```

## 使用场景

### 适合使用 Plan Agent 的场景：

1. **大型功能开发**
   - 需要多个模块协同
   - 涉及多个开发阶段
   - 需要明确的里程碑

2. **系统重构**
   - 影响范围广
   - 需要分步骤执行
   - 风险需要控制

3. **复杂问题解决**
   - 问题原因不明确
   - 需要系统性排查
   - 涉及多个组件

4. **技术迁移**
   - 框架升级
   - 数据迁移
   - 架构调整

### 不适合使用 Plan Agent 的场景：

- ❌ 简单的单文件修改
- ❌ 明确的直接任务（如"运行测试"）
- ❌ 紧急的热修复（hotfix）

## 使用示例

### 示例 1：实现用户认证系统

**用户请求**：
```
请为实现用户认证系统制定详细的执行计划
```

**Plan Agent 工作流**：

1. **分析阶段**（步骤 1-2）
   - 使用 Think 分析认证需求
   - 使用 ReadFile/Glob 了解现有代码结构
   - 识别技术栈和框架

2. **规划阶段**（步骤 3）
   - 创建任务清单：
     ```
     1. 设计认证 API 接口规范
     2. 设计用户数据表结构
     3. 实现密码加密工具类
     4. 实现用户注册逻辑
     5. 实现用户登录逻辑
     6. 实现 JWT Token 生成和验证
     7. 添加认证拦截器
     8. 编写单元测试
     9. 编写集成测试
     10. 测试安全性（SQL注入、XSS等）
     11. 性能测试和优化
     12. 更新 API 文档
     ```

3. **执行阶段**（步骤 4-15）
   - 委托 Design-Agent 完成任务 1-2
   - 委托 Code-Agent 完成任务 3-7
   - 委托 Test-Agent 完成任务 8-11
   - 委托 Doc-Agent 完成任务 12
   - 每完成一个任务，更新状态

4. **总结阶段**（步骤 16）
   - 验证所有功能
   - 总结关键决策
   - 识别潜在改进点

### 示例 2：修复复杂 Bug

**用户请求**：
```
订单模块在高并发场景下偶发数据不一致，请制定排查和修复计划
```

**Plan Agent 工作流**：

1. **问题分析**
   - Think 分析可能原因：并发控制、事务隔离、缓存一致性
   - ReadFile 阅读订单相关代码
   - Grep 搜索事务相关代码

2. **创建排查计划**
   ```
   1. 复现问题并收集日志
   2. 分析事务隔离级别
   3. 检查锁机制实现
   4. 检查缓存一致性策略
   5. 分析并发测试结果
   6. 定位根本原因
   7. 设计修复方案
   8. 实现修复代码
   9. 编写并发测试用例
   10. 压力测试验证
   ```

3. **执行和验证**
   - 委托 Debug-Agent 排查问题
   - 委托 Code-Agent 实现修复
   - 委托 Test-Agent 进行测试
   - 跟踪进度并调整计划

### 示例 3：系统重构

**用户请求**：
```
将单体应用的用户模块拆分为微服务，制定迁移计划
```

**Plan Agent 工作流**：

1. **深度分析**
   - 分析用户模块边界
   - 评估服务依赖关系
   - 识别数据迁移需求
   - 评估风险和挑战

2. **分阶段计划**
   ```
   阶段 1：准备工作
     1. 梳理用户模块 API 清单
     2. 分析数据库表依赖关系
     3. 设计微服务接口规范
     4. 设计数据迁移策略
   
   阶段 2：服务开发
     5. 创建微服务项目脚手架
     6. 迁移业务逻辑代码
     7. 实现服务间通信
     8. 实现配置中心集成
   
   阶段 3：数据迁移
     9. 准备数据迁移脚本
     10. 执行数据库拆分
     11. 验证数据完整性
   
   阶段 4：测试验证
     12. 单元测试
     13. 集成测试
     14. 性能测试
     15. 灰度发布测试
   
   阶段 5：上线部署
     16. 准备回滚方案
     17. 生产环境部署
     18. 监控和观察
   ```

3. **风险控制**
   - 每阶段设置验证点
   - 准备回滚方案
   - 逐步迁移流量

## 委托 Plan Agent

### 从 Default Agent 委托

```
请使用 Plan-Agent 为实现订单管理系统制定详细的执行计划
```

### 从命令行直接使用

```bash
# 切换到 Plan Agent
/agent plan

# 输入任务
请为重构支付模块制定详细计划
```

## 任务清单状态说明

Plan Agent 使用 SetTodoList 工具管理任务，支持以下状态：

- **Pending**：待执行
- **In Progress**：执行中
- **Done**：已完成
- **Cancelled**：已取消
- **Error**：执行出错

## 配置说明

Plan Agent 的配置文件位于 `agents/plan/agent.yaml`：

```yaml
# 使用更强的推理模型进行规划
model: qwen3-max

# 精简到规划所需的核心工具
tools:
  - Think           # 深度思考
  - SetTodoList     # 任务管理
  - ReadFile        # 了解上下文
  - Glob            # 查找文件
  - Grep            # 搜索代码
  - SearchWeb       # 搜索信息
  - FetchURL        # 获取网页
  - Task            # 委托执行
```

## 最佳实践

### ✅ 推荐做法

1. **明确目标**：向 Plan Agent 提供清晰的任务目标和约束条件
2. **提供上下文**：说明项目背景、技术栈、已有实现
3. **信任规划**：等待 Plan Agent 完成完整规划再执行
4. **跟踪进度**：关注任务状态更新
5. **反馈调整**：发现问题及时反馈，让 Plan Agent 调整计划

### ❌ 避免做法

1. **不要中途干预**：等待规划阶段完成
2. **不要频繁切换**：让 Plan Agent 完成整个流程
3. **不要过度细化**：信任 Plan Agent 的任务拆分
4. **不要忽略验证**：重视 Plan Agent 设置的验证步骤

## 工作模式对比

### ReAct 模式（Default Agent）
- 边思考边行动
- 适合简单直接的任务
- 快速响应
- 灵活调整

### Plan-Execute 模式（Plan Agent）
- 先规划后执行
- 适合复杂多步骤任务
- 结构化清晰
- 可追踪进度
- 风险可控

## 常见问题

### Q: 什么时候应该使用 Plan Agent？

A: 当任务满足以下条件之一时：
- 需要 5 个以上的步骤
- 涉及多个模块或组件
- 需要协调多个专业 Agent
- 有明确的阶段和里程碑
- 风险需要系统性管理

### Q: Plan Agent 会自己执行代码修改吗？

A: 不会。Plan Agent 负责规划，具体执行会委托给：
- Code-Agent（代码实现）
- Build-Agent（构建编译）
- Test-Agent（测试验证）
- Review-Agent（代码审查）

### Q: 如何查看任务进度？

A: Plan Agent 会通过 SetTodoList 工具实时显示任务状态，你可以看到：
- 总任务数
- 已完成任务数
- 当前执行的任务
- 每个任务的状态

### Q: 计划执行中可以调整吗？

A: 可以。Plan Agent 支持动态调整：
- 根据执行反馈添加新任务
- 更新任务状态
- 调整任务优先级
- 取消不再需要的任务

## 总结

Plan Agent 是处理复杂任务的理想选择，它通过 Plan-Execute 模式：

1. **提高成功率**：完整规划减少遗漏
2. **降低风险**：分步执行便于控制
3. **提升效率**：合理委托充分利用专业 Agent
4. **增强可见性**：清晰的进度跟踪

适合需要系统性规划和执行的复杂开发任务。
