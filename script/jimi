#!/bin/bash
#
# Jimi - Java Implementation of Moonshot Intelligence
# 启动脚本
#

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# JAR 文件路径
JAR_FILE="$SCRIPT_DIR/target/jimi-0.1.0.jar"

# 检查 JAR 文件是否存在
if [ ! -f "$JAR_FILE" ]; then
    echo "错误: 找不到 JAR 文件: $JAR_FILE"
    echo "请先运行: mvn clean package"
    exit 1
fi

# 检查 JAVA_HOME
if [ -z "$JAVA_HOME" ]; then
    # 尝试自动检测 Java 17
    if [ -d "/Library/Java/JavaVirtualMachines/jdk-17.jdk/Contents/Home" ]; then
        export JAVA_HOME="/Library/Java/JavaVirtualMachines/jdk-17.jdk/Contents/Home"
    elif [ -d "/Library/Java/JavaVirtualMachines/openjdk-17.jdk/Contents/Home" ]; then
        export JAVA_HOME="/Library/Java/JavaVirtualMachines/openjdk-17.jdk/Contents/Home"
    else
        echo "警告: JAVA_HOME 未设置，使用系统默认 Java"
    fi
fi

# 设置 Java 可执行文件路径
if [ -n "$JAVA_HOME" ]; then
    JAVA_CMD="$JAVA_HOME/bin/java"
else
    JAVA_CMD="java"
fi

# 检查 Java 版本
JAVA_VERSION=$("$JAVA_CMD" -version 2>&1 | awk -F '"' '/version/ {print $2}' | awk -F '.' '{print $1}')
if [ "$JAVA_VERSION" -lt 17 ]; then
    echo "错误: 需要 Java 17 或更高版本 (当前版本: $JAVA_VERSION)"
    exit 1
fi

# JVM 参数
JVM_OPTS="${JVM_OPTS:--Xms256m -Xmx2g}"

# 运行 JAR
exec "$JAVA_CMD" $JVM_OPTS -jar "$JAR_FILE" "$@"
